<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registreerimistasu ja Aastamaksu Kalkulaator</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Registreerimistasu ja aastamaksu kalkulaator</h1>
        <div class="row justify-content-center">
            <div class="col-md-6">
                <form id="calculatorForm">
                    <div class="form-group">
                        <label for="taxType">Maksu tüüp:</label>
                        <select id="taxType" class="form-control">
                            <option value="annual">Aastamaks</option>
                            <option value="registration">Registreerimistasu</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="taxYear">Maks aastal:</label>
                        <select id="taxYear" class="form-control">
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                            <option value="2031">2031</option>
                            <option value="2032">2032</option>
                            <option value="2033">2033</option>
                            <option value="2034">2034</option>
                            <option value="2035">2035</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="regYear">Masina esmase registreerimise aasta:</label>
                        <input type="number" id="regYear" class="form-control" required>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" id="electricCar" class="form-check-input" onchange="toggleElectric(event)">
                        <label for="electricCar" class="form-check-label">Elektriauto</label>
                    </div>

                    <div class="form-group">
                        <label for="co2">CO<sub>2</sub> heitkogused (g/km):</label>
                        <input type="number" id="co2" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="mass">Täismass (kg):</label>
                        <input type="number" id="mass" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="vehicleType">Sõidukitüüp:</label>
                        <select id="vehicleType" class="form-control" onchange="toggleVan(event)">
                            <option value="car">Sõiduauto</option>
                            <option value="van">Kaubik</option>
                        </select>
                    </div>

                    <button type="button" onclick="doCalculations()" class="btn btn-primary">Arvuta</button>
                </form>
            </div>
        </div>

        <div id="resultDiv" hidden class="row justify-content-center mt-4">
            <div class="col-md-6">
                <h2 class="text-center">Tulemus:</h2>
                <p class="text-center"><span id="calcResult"></span></p>
            </div>
        </div>
    </div>

    <script>
	
		function toggleElectric(e) {
			if (e.target.checked) {
				document.getElementById('co2').value = "";
				document.getElementById('co2').disabled = true;
			} else {
				document.getElementById('co2').disabled = false;
			}
		}

		function toggleVan(e) {
			if (document.getElementById('vehicleType').value === "van") {
				document.getElementById('mass').value = "";
				document.getElementById('mass').disabled = true;
			} else {
				document.getElementById('mass').disabled = false;
			}
		}

		function getAgeModifier(age) {
			let ageModifier = 1;
			if (age >= 5 && age <= 14) {
				ageModifier -= 0.09 * (age - 4)
			} else if (age >=15 && age < 20) {
				return 0.1;
			} else if (age >= 20) {
				return 0;
			}
			return ageModifier;
		}
	
		function getEmissionPrice(co2, isAnnual, isElectric, vehicleType) {
			if (isElectric) {
				return 0;
			}
			let emissionPrice = 0;
			let foreachEnd = false;
			let steps = [];
			if (vehicleType === "van") {
				steps = [
					{"stepRangeBegin": 0, "stepRangeEnd": 204, "annualPrice": 0, "registerPrice": 0},
					{"stepRangeBegin": 204, "stepRangeEnd": 250, "annualPrice": 3, "registerPrice": 30},
					{"stepRangeBegin": 250, "stepRangeEnd": 300, "annualPrice": 3.5, "registerPrice": 35},
					{"stepRangeBegin": 300, "stepRangeEnd": co2, "annualPrice": 4, "registerPrice": 40}
				];
			} else {
				steps = [
					{"stepRangeBegin": 0, "stepRangeEnd": 117, "annualPrice": 0, "registerPrice": 5},
					{"stepRangeBegin": 117, "stepRangeEnd": 150, "annualPrice": 3, "registerPrice": 40},
					{"stepRangeBegin": 150, "stepRangeEnd": 200, "annualPrice": 3.5, "registerPrice": 60},
					{"stepRangeBegin": 200, "stepRangeEnd": co2, "annualPrice": 4, "registerPrice": 80}
				];
			}
			steps.forEach((step) =>
				{
					if (foreachEnd) {
						return;
					}
					if (co2 <= step.stepRangeEnd) {
						emissionPrice += (co2 - step.stepRangeBegin) * (isAnnual ? step.annualPrice : step.registerPrice);
						foreachEnd = true;
					} else {
						emissionPrice += (step.stepRangeEnd - step.stepRangeBegin) * (isAnnual ? step.annualPrice : step.registerPrice);
					}
				}
			);
			return emissionPrice;
		}
	
		function getMassPrice(mass, isAnnual, isElectric) {
			let massPrice = 0;
			let kgPrice = isAnnual ? .4 : 4;
			
			if (isElectric) {
				if (mass > 2400) {
					massPrice += Math.min((mass - 2400) * kgPrice, 1100 * kgPrice);
				}
			} else {
				if (mass > 2000) {
					massPrice += Math.min((mass - 2000) * kgPrice, 1000 * kgPrice);
				}
			}
			return massPrice;
		}
	
		function getBaseFee(vehicleType, isElectric, isAnnual) {
			if (isAnnual) {
				return 50;
			} else {
				if (vehicleType === "van" && !isElectric) {
					return 500;
				}
				return 300;
			}
		}
	
		function calculateFee(isAnnual) {
			const age = parseInt(document.getElementById('taxYear').value) - parseInt(document.getElementById('regYear').value);
			const co2 = parseFloat(document.getElementById('co2').value);
			const mass = parseFloat(document.getElementById('mass').value);
			const vehicleType = document.getElementById('vehicleType').value;
			const isElectric = document.getElementById('electricCar').checked;

			let tax = 0;

			tax += getEmissionPrice(co2, isAnnual, isElectric, vehicleType);

			if (vehicleType !== "van") {
				tax += getMassPrice(mass, isAnnual, isElectric);
				tax *= getAgeModifier(age);
			}
			

			tax += getBaseFee(vehicleType, isElectric, isAnnual);
			return tax;
		}


        function doCalculations() {
			document.getElementById('resultDiv').hidden = false;
			let taxType = document.getElementById('taxType').value;
			let fee = calculateFee( taxType === "registration" );
			
			document.getElementById('calcResult').textContent = (taxType === 'registration' ? 'Registreerimistasu' : 'Aastamaks') + ': ' + fee.toFixed(2) + ' €';

        }
    </script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
